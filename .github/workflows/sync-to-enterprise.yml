name: Sync to Enterprise GitHub

on:
  push:
    branches:
      - '**'
      - '!gh-pages'
  workflow_dispatch:

jobs:
  sync:
    # Only run on the source GitHub repository, not on the enterprise mirror
    if: github.server_url == 'https://github.com'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to Enterprise Repo
        env:
          ENTERPRISE_TOKEN: ${{ secrets.ENTERPRISE_GITHUB_TOKEN }}
        run: |
          if [ -z "$ENTERPRISE_TOKEN" ]; then
            echo "Error: ENTERPRISE_GITHUB_TOKEN secret is not set."
            echo "Please set the ENTERPRISE_GITHUB_TOKEN secret in the repository settings."
            exit 1
          fi

          # Target Repository URL
          TARGET_REPO="github.tools.sap/AIAM/agent-identity-ias-tenant-view.git"
          TARGET_URL="https://oauth2:$ENTERPRISE_TOKEN@$TARGET_REPO"
          
          echo "Adding enterprise remote..."
          git remote add enterprise "$TARGET_URL"
          
          echo "Syncing branches..."
          # Push all references from origin to enterprise, excluding gh-pages
          git for-each-ref --format='%(refname:short)' refs/remotes/origin/ | grep -vFx "origin/gh-pages" | grep -vFx "origin/HEAD" | while read remote; do
            branch=${remote#origin/}
            echo "Pushing $branch..."
            git push enterprise "$remote:refs/heads/$branch" --force
          done
          
          echo "Syncing tags..."
          git push enterprise --tags --force
          
          # Update homepage in package.json for the current branch
          if [[ "$GITHUB_REF" == refs/heads/* ]]; then
            echo "Updating homepage in package.json..."
            
            # Construct Homepage URL (remove .git suffix)
            HOMEPAGE_URL="https://${TARGET_REPO%.git}"
            
            # Update homepage using jq
            jq --indent 2 --arg homepage "$HOMEPAGE_URL" '.homepage = $homepage' package.json > package.json.tmp && mv package.json.tmp package.json

            # Update runs-on in deploy.yml for enterprise
            echo "Updating deploy.yml runs-on to solinas..."
            sed -i 's/runs-on: ubuntu-latest/runs-on: solinas/g' .github/workflows/deploy.yml
            
            # Configure git
            git config user.name "GitHub Action"
            git config user.email "action@github.com"
            
            # Commit the change
            git add package.json .github/workflows/deploy.yml
            git commit -m "chore: update homepage and runner for enterprise deployment" || echo "No changes to commit"
            
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            echo "Pushing modified branch $BRANCH_NAME..."
            git push enterprise HEAD:refs/heads/$BRANCH_NAME --force
          fi
