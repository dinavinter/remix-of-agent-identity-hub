name: Deploy to GitHub Pages

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm i

      - name: Determine Base Path and Target Folder
        id: config
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "base_path=/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
            echo "target_folder=." >> $GITHUB_OUTPUT
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            echo "base_path=/${{ github.event.repository.name }}/${{ github.ref_name }}/" >> $GITHUB_OUTPUT
            echo "target_folder=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "clean=false" >> $GITHUB_OUTPUT
          fi

      - name: Build
        run: npm run build
        env:
          BASE_PATH: ${{ steps.config.outputs.base_path }}

      - name: Deploy to GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Dynamically determine the git host domain from github.server_url
          SERVER_URL="${{ github.server_url }}"
          DOMAIN="${SERVER_URL#*://}"
          
          git remote set-url origin "https://git:${GITHUB_TOKEN}@${DOMAIN}/${GITHUB_REPOSITORY}.git"
          
          ADD_FLAG=""
          if [[ "${{ steps.config.outputs.clean }}" == "false" ]]; then
            ADD_FLAG="--add"
          fi
          
          npx gh-pages -d dist -u "github-actions-bot <support+actions@github.com>" \
            --branch gh-pages \
            --dest "${{ steps.config.outputs.target_folder }}" \
            $ADD_FLAG
