name: Deploy to GitHub Pages

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm i

      - name: Determine Base Path and Target Folder
        id: config
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            # If CNAME is used, main should be served from root path /
            echo "base_path=/" >> $GITHUB_OUTPUT
            echo "target_folder=." >> $GITHUB_OUTPUT
            echo "clean=true" >> $GITHUB_OUTPUT
          else
            # Feature branches are subdirectories
            echo "base_path=/${{ github.ref_name }}/" >> $GITHUB_OUTPUT
            echo "target_folder=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "clean=false" >> $GITHUB_OUTPUT
          fi

      - name: Build
        run: npm run build
        env:
          BASE_PATH: ${{ steps.config.outputs.base_path }}

      - name: Deploy to GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CNAME_DOMAIN: ${{ vars.CNAME_DOMAIN || 'agents.ias.authz.id' }}
        run: |
          # Dynamically determine the git host domain from github.server_url
          SERVER_URL="${{ github.server_url }}"
          DOMAIN="${SERVER_URL#*://}"
          
          git remote set-url origin "https://git:${GITHUB_TOKEN}@${DOMAIN}/${GITHUB_REPOSITORY}.git"
          
          ADD_FLAG=""
          CNAME_FLAG=""
          
          if [[ "${{ steps.config.outputs.clean }}" == "false" ]]; then
            ADD_FLAG="--add"
          else
            # Only set CNAME for the main/root deployment
            if [[ -n "$CNAME_DOMAIN" ]]; then
               CNAME_FLAG="--cname $CNAME_DOMAIN"
               
               # Update package.json homepage for consistency if running on main branch
               echo "Updating package.json homepage to https://$CNAME_DOMAIN"
               jq --indent 2 --arg homepage "https://$CNAME_DOMAIN" '.homepage = $homepage' package.json > package.json.tmp && mv package.json.tmp package.json
            fi
          fi
          
          npx gh-pages -d dist -u "github-actions-bot <support+actions@github.com>" \
            --branch gh-pages \
            --dest "${{ steps.config.outputs.target_folder }}" \
            $ADD_FLAG \
            $CNAME_FLAG
